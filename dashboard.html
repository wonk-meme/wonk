<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WONK Dashboard - Your Crypto Voting Hub</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Firebase Scripts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.15.0/firebase-app-compat.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.15.0/firebase-auth-compat.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.15.0/firebase-firestore-compat.min.js"></script>
  
  <!-- Web3 and Blockchain Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/web3@1.8.0/dist/web3.min.js"></script>
  
  <!-- Application Scripts -->
  <script src="database.js"></script>
  <script src="blockchain_integration.js"></script>
  <script src="blockchain_voting_ui.js"></script>
  
  <style>
    :root {
      --primary-blue: #00d4ff;
      --secondary-blue: #0099cc;
      --primary-gold: #ffd700;
      --secondary-gold: #ffb347;
      --dark-bg: #0a0e1a;
      --darker-bg: #050810;
      --glass-blue: rgba(0, 212, 255, 0.1);
      --glass-gold: rgba(255, 215, 0, 0.1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: linear-gradient(135deg, var(--darker-bg) 0%, var(--dark-bg) 50%, #1a0f2e 100%);
      font-family: 'Rajdhani', sans-serif;
      color: #ffffff;
      overflow-x: hidden;
      position: relative;
      min-height: 100vh;
    }

    /* Animated Background Grid */
    .grid-bg {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0.1;
      background-image: 
        linear-gradient(var(--primary-blue) 1px, transparent 1px),
        linear-gradient(90deg, var(--primary-blue) 1px, transparent 1px);
      background-size: 50px 50px;
      animation: gridMove 20s linear infinite;
      z-index: -1;
    }

    @keyframes gridMove {
      0% { transform: translate(0, 0); }
      100% { transform: translate(50px, 50px); }
    }

    /* Glowing Effects */
    .glow-blue {
      color: var(--primary-blue);
      text-shadow: 0 0 10px var(--primary-blue), 0 0 20px var(--primary-blue), 0 0 40px var(--primary-blue);
    }

    .glow-gold {
      color: var(--primary-gold);
      text-shadow: 0 0 10px var(--primary-gold), 0 0 20px var(--primary-gold), 0 0 40px var(--primary-gold);
    }

    /* Glass Morphism */
    .glass-panel {
      background: linear-gradient(135deg, var(--glass-blue) 0%, var(--glass-gold) 100%);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }

    .glass-dark {
      background: rgba(10, 14, 26, 0.8);
      backdrop-filter: blur(15px);
      border: 1px solid rgba(0, 212, 255, 0.3);
      border-radius: 15px;
    }

    /* Header */
    .cyber-header {
      position: relative;
      background: linear-gradient(135deg, var(--darker-bg) 0%, var(--dark-bg) 100%);
      border-bottom: 2px solid var(--primary-blue);
      box-shadow: 0 5px 20px rgba(0, 212, 255, 0.3);
    }

    .cyber-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, transparent 0%, var(--primary-blue) 50%, transparent 100%);
      animation: scan 3s linear infinite;
    }

    @keyframes scan {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    /* Action Buttons */
    .action-btn {
      position: relative;
      padding: 12px 24px;
      margin: 5px;
      background: linear-gradient(45deg, var(--primary-blue), var(--secondary-blue));
      border: 2px solid var(--primary-blue);
      border-radius: 25px;
      color: white;
      font-family: 'Orbitron', monospace;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      cursor: pointer;
      transition: all 0.3s ease;
      overflow: hidden;
      text-decoration: none;
      display: inline-block;
    }

    .action-btn:hover {
      background: linear-gradient(45deg, var(--primary-gold), var(--secondary-gold));
      border-color: var(--primary-gold);
      box-shadow: 0 0 30px rgba(255, 215, 0, 0.6);
      transform: translateY(-2px);
    }

    .action-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }

    .action-btn:hover::before {
      left: 100%;
    }

    .danger-btn {
      background: linear-gradient(45deg, #dc2626, #b91c1c);
      border-color: #dc2626;
    }

    .danger-btn:hover {
      background: linear-gradient(45deg, #ef4444, #dc2626);
      border-color: #ef4444;
      box-shadow: 0 0 30px rgba(239, 68, 68, 0.6);
    }

    /* User Profile Card */
    .profile-card {
      position: relative;
      overflow: hidden;
    }

    .profile-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 100px;
      background: linear-gradient(45deg, var(--primary-blue), var(--primary-gold));
      opacity: 0.3;
    }

    .profile-avatar {
      position: relative;
      z-index: 2;
      width: 80px;
      height: 80px;
      border-radius: 50%;
      border: 4px solid var(--primary-gold);
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
      margin: 0 auto;
      background: linear-gradient(45deg, var(--primary-blue), var(--primary-gold));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      font-weight: bold;
    }

    /* Points Display */
    .points-display {
      background: linear-gradient(45deg, var(--primary-gold), var(--secondary-gold));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-family: 'Orbitron', monospace;
      font-weight: 900;
      font-size: 2.5rem;
      text-align: center;
      animation: pointsGlow 2s ease-in-out infinite alternate;
    }

    @keyframes pointsGlow {
      0% { filter: brightness(1); }
      100% { filter: brightness(1.3); }
    }

    /* Voting Cards */
    .voting-card {
      transition: all 0.4s ease;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .voting-card:hover {
      transform: translateY(-10px) scale(1.02);
      box-shadow: 0 20px 40px rgba(0, 212, 255, 0.3);
    }

    .voting-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(45deg, var(--glass-blue), var(--glass-gold));
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .voting-card:hover::before {
      opacity: 0.1;
    }

    /* Live Feed */
    .live-feed {
      max-height: 400px;
      overflow-y: auto;
    }

    .live-feed::-webkit-scrollbar {
      width: 6px;
    }

    .live-feed::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 3px;
    }

    .live-feed::-webkit-scrollbar-thumb {
      background: var(--primary-blue);
      border-radius: 3px;
    }

    /* Animations */
    .animate-fade-in {
      animation: fadeIn 0.5s ease-in-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .pulse-glow {
      animation: pulseGlow 2s ease-in-out infinite alternate;
    }

    @keyframes pulseGlow {
      0% { box-shadow: 0 0 20px rgba(0, 212, 255, 0.3); }
      100% { box-shadow: 0 0 40px rgba(255, 215, 0, 0.5); }
    }

    /* Modal Styles */
    .modal-overlay {
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
    }

    .modal-content {
      background: linear-gradient(135deg, var(--dark-bg) 0%, var(--darker-bg) 100%);
      border: 2px solid var(--primary-blue);
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }

    /* Input Fields */
    .input-field {
      background: rgba(10, 14, 26, 0.8);
      border: 2px solid rgba(0, 212, 255, 0.3);
      border-radius: 10px;
      padding: 12px 16px;
      color: white;
      font-family: 'Rajdhani', sans-serif;
      font-size: 16px;
      transition: all 0.3s ease;
    }

    .input-field:focus {
      outline: none;
      border-color: var(--primary-blue);
      box-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .points-display {
        font-size: 2rem;
      }
      
      .profile-avatar {
        width: 60px;
        height: 60px;
        font-size: 1.5rem;
      }
    }
  </style>
</head>

<body>
  <!-- Animated Grid Background -->
  <div class="grid-bg"></div>

  <!-- Header -->
  <header class="cyber-header fixed w-full top-0 z-50">
    <div class="container mx-auto px-6 py-4">
      <div class="flex items-center justify-between">
        <!-- Logo -->
        <div class="flex items-center">
          <div class="w-12 h-12 bg-gradient-to-br from-blue-400 to-blue-600 rounded-full flex items-center justify-center text-xl font-bold">
            W
          </div>
          <span class="ml-3 text-2xl font-bold glow-blue font-mono">WONK DASHBOARD</span>
        </div>

        <!-- User Info -->
        <div class="flex items-center space-x-4">
          <div class="text-right hidden md:block">
            <div class="text-sm text-gray-400">Welcome back</div>
            <div class="text-lg font-bold glow-gold" id="headerUserName">Loading...</div>
          </div>
          <button onclick="logout()" class="action-btn danger-btn">
            <i class="fas fa-sign-out-alt mr-2"></i>
            Logout
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="pt-24 pb-12">
    <div class="container mx-auto px-6">
      <!-- User Profile Section -->
      <section class="mb-12">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
          <!-- Profile Card -->
          <div class="profile-card glass-panel p-8 rounded-3xl text-center">
            <div class="profile-avatar mb-4" id="userAvatar">
              <i class="fas fa-user"></i>
            </div>
            <h2 class="text-2xl font-bold mb-2 glow-blue" id="userName">Loading...</h2>
            <p class="text-gray-400 mb-4" id="userEmail">Loading...</p>
            <div class="text-sm text-gray-500" id="userId">ID: Loading...</div>
            <div class="mt-4">
              <span class="px-3 py-1 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full text-xs font-bold" id="loginMethod">
                Loading...
              </span>
            </div>
          </div>

          <!-- Points Card -->
          <div class="glass-panel p-8 rounded-3xl text-center pulse-glow">
            <div class="mb-4">
              <i class="fas fa-coins text-6xl glow-gold"></i>
            </div>
            <h3 class="text-xl font-bold mb-2 text-gray-300">Your Points</h3>
            <div class="points-display" id="userPointsDisplay">0</div>
            <p class="text-gray-400 text-sm mt-2">Available for voting</p>
            <button onclick="showBuyPointsModal()" class="action-btn mt-4">
              <i class="fas fa-shopping-cart mr-2"></i>
              Buy Points
            </button>
          </div>

          <!-- Stats Card -->
          <div class="glass-panel p-8 rounded-3xl">
            <h3 class="text-xl font-bold mb-6 glow-gold text-center">Your Stats</h3>
            <div class="space-y-4">
              <div class="flex justify-between items-center">
                <span class="text-gray-400">Total Votes:</span>
                <span class="font-bold text-blue-400" id="userTotalVotes">0</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-gray-400">Points Spent:</span>
                <span class="font-bold text-red-400" id="userPointsSpent">0</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-gray-400">Member Since:</span>
                <span class="font-bold text-green-400" id="userJoinDate">Loading...</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-gray-400">Wallet:</span>
                <span class="font-bold text-purple-400 text-xs" id="userWallet">Not Connected</span>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Voting Section -->
      <section class="mb-12">
        <div class="flex items-center justify-between mb-8">
          <h2 class="text-4xl font-bold glow-blue font-mono">Vote for Crypto</h2>
          <div class="flex items-center space-x-4">
            <div class="text-right">
              <div class="text-sm text-gray-400">Voting Mode</div>
              <div class="flex items-center space-x-2">
                <button id="traditionalVoteBtn" onclick="switchVotingMode('traditional')" class="action-btn text-sm">
                  Traditional
                </button>
                <button id="blockchainVoteBtn" onclick="switchVotingMode('blockchain')" class="action-btn text-sm">
                  Blockchain
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Voting Mode Info -->
        <div id="votingModeInfo" class="glass-panel p-4 rounded-2xl mb-6">
          <div class="flex items-center space-x-3">
            <i class="fas fa-info-circle text-blue-400"></i>
            <div>
              <div class="font-bold" id="votingModeTitle">Traditional Voting Mode</div>
              <div class="text-sm text-gray-400" id="votingModeDescription">
                Votes are stored in our secure database. Fast and reliable.
              </div>
            </div>
          </div>
        </div>

        <!-- Voting Cards -->
        <div id="votingCards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          <!-- Voting cards will be loaded here -->
        </div>
      </section>

      <!-- Live Activity Section -->
      <section class="mb-12">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
          <!-- Live Votes Feed -->
          <div class="glass-panel p-6 rounded-3xl">
            <h3 class="text-2xl font-bold mb-6 glow-gold text-center">
              <i class="fas fa-broadcast-tower mr-2"></i>
              Live Votes Feed
            </h3>
            <div id="liveVotesFeed" class="live-feed space-y-3">
              <!-- Live votes will be loaded here -->
            </div>
          </div>

          <!-- Account Management -->
          <div class="glass-panel p-6 rounded-3xl">
            <h3 class="text-2xl font-bold mb-6 glow-gold text-center">
              <i class="fas fa-cog mr-2"></i>
              Account Settings
            </h3>
            <div class="space-y-4">
              <button onclick="showChangePasswordModal()" class="action-btn w-full">
                <i class="fas fa-key mr-2"></i>
                Change Password
              </button>
              <button onclick="connectPhantomWallet()" class="action-btn w-full">
                <i class="fas fa-wallet mr-2"></i>
                Connect Phantom Wallet
              </button>
              <button onclick="showTransactionHistory()" class="action-btn w-full">
                <i class="fas fa-history mr-2"></i>
                Transaction History
              </button>
              <button onclick="exportUserData()" class="action-btn w-full">
                <i class="fas fa-download mr-2"></i>
                Export Data
              </button>
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- Buy Points Modal -->
  <div id="buyPointsModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 hidden">
    <div class="modal-content p-8 rounded-3xl max-w-md w-full mx-4">
      <div class="text-center mb-6">
        <i class="fas fa-coins text-6xl glow-gold mb-4"></i>
        <h2 class="text-3xl font-bold glow-blue">Buy Points</h2>
        <p class="text-gray-400 mt-2">Purchase points to continue voting</p>
      </div>
      
      <div class="space-y-4 mb-6">
        <div class="glass-dark p-4 rounded-2xl cursor-pointer hover:bg-opacity-80" onclick="selectPointsPackage(100, 0.01)">
          <div class="flex justify-between items-center">
            <div>
              <div class="font-bold text-lg">100 Points</div>
              <div class="text-sm text-gray-400">Basic Package</div>
            </div>
            <div class="text-right">
              <div class="font-bold text-gold-400">0.01 SOL</div>
              <div class="text-xs text-gray-400">~$2.50</div>
            </div>
          </div>
        </div>
        
        <div class="glass-dark p-4 rounded-2xl cursor-pointer hover:bg-opacity-80" onclick="selectPointsPackage(500, 0.045)">
          <div class="flex justify-between items-center">
            <div>
              <div class="font-bold text-lg">500 Points</div>
              <div class="text-sm text-gray-400">Popular Package</div>
            </div>
            <div class="text-right">
              <div class="font-bold text-gold-400">0.045 SOL</div>
              <div class="text-xs text-gray-400">~$11.25</div>
            </div>
          </div>
        </div>
        
        <div class="glass-dark p-4 rounded-2xl cursor-pointer hover:bg-opacity-80" onclick="selectPointsPackage(1000, 0.08)">
          <div class="flex justify-between items-center">
            <div>
              <div class="font-bold text-lg">1000 Points</div>
              <div class="text-sm text-gray-400">Best Value</div>
            </div>
            <div class="text-right">
              <div class="font-bold text-gold-400">0.08 SOL</div>
              <div class="text-xs text-gray-400">~$20.00</div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="flex space-x-4">
        <button onclick="hideBuyPointsModal()" class="action-btn danger-btn flex-1">
          Cancel
        </button>
        <button id="purchasePointsBtn" onclick="purchasePoints()" class="action-btn flex-1" disabled>
          Purchase
        </button>
      </div>
    </div>
  </div>

  <!-- Change Password Modal -->
  <div id="changePasswordModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 hidden">
    <div class="modal-content p-8 rounded-3xl max-w-md w-full mx-4">
      <h2 class="text-2xl font-bold text-center mb-6 glow-blue">Change Password</h2>
      <form id="changePasswordForm" class="space-y-4">
        <div>
          <label class="block text-sm font-medium mb-2">Current Password</label>
          <input type="password" id="currentPassword" class="input-field w-full" required>
        </div>
        <div>
          <label class="block text-sm font-medium mb-2">New Password</label>
          <input type="password" id="newPassword" class="input-field w-full" required>
        </div>
        <div>
          <label class="block text-sm font-medium mb-2">Confirm New Password</label>
          <input type="password" id="confirmPassword" class="input-field w-full" required>
        </div>
        <div class="flex space-x-4 mt-6">
          <button type="button" onclick="hideChangePasswordModal()" class="action-btn danger-btn flex-1">
            Cancel
          </button>
          <button type="submit" class="action-btn flex-1">
            Update Password
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Transaction History Modal -->
  <div id="transactionHistoryModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 hidden">
    <div class="modal-content p-8 rounded-3xl max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">
      <h2 class="text-2xl font-bold text-center mb-6 glow-blue">Transaction History</h2>
      <div id="transactionHistoryContent" class="space-y-3">
        <!-- Transaction history will be loaded here -->
      </div>
      <div class="text-center mt-6">
        <button onclick="hideTransactionHistory()" class="action-btn">
          Close
        </button>
      </div>
    </div>
  </div>

  <!-- Dashboard JavaScript -->
  <script>
    // Global variables
    let currentUser = null;
    let userPoints = 0;
    let votingMode = 'traditional'; // 'traditional' or 'blockchain'
    let selectedPointsPackage = null;

    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', function() {
      initializeDashboard();
    });

    // Initialize dashboard functionality
    async function initializeDashboard() {
      try {
        // Check if user is logged in
        await checkUserAuthentication();
        
        // Load user data
        await loadUserData();
        
        // Load voting cards
        await loadVotingCards();
        
        // Start live feeds
        startLiveVotesFeed();
        
        // Setup event listeners
        setupEventListeners();
        
        console.log('Dashboard initialized successfully');
      } catch (error) {
        console.error('Error initializing dashboard:', error);
        // Redirect to login if not authenticated
        window.location.href = 'index.html';
      }
    }

    // Check user authentication
    async function checkUserAuthentication() {
      // Check for stored user data or Firebase auth
      const storedUser = localStorage.getItem('currentUser');
      if (storedUser) {
        currentUser = JSON.parse(storedUser);
      } else if (firebase.auth().currentUser) {
        const user = firebase.auth().currentUser;
        currentUser = {
          uid: user.uid,
          email: user.email,
          displayName: user.displayName || "User",
          photoURL: user.photoURL,
          loginMethod: "google"
        };
      } else {
        throw new Error('User not authenticated');
      }
    }

    // Load user data
    async function loadUserData() {
      try {
        // Update UI with user info
        document.getElementById('userName').textContent = currentUser.displayName || 'User';
        document.getElementById('headerUserName').textContent = currentUser.displayName || 'User';
        document.getElementById('userEmail').textContent = currentUser.email || 'No email';
        document.getElementById('userId').textContent = `ID: ${currentUser.uid.substring(0, 12)}...`;
        document.getElementById('loginMethod').textContent = currentUser.loginMethod || 'Unknown';
        
        // Set user avatar
        const avatar = document.getElementById('userAvatar');
        if (currentUser.photoURL) {
          avatar.innerHTML = `<img src="${currentUser.photoURL}" alt="Avatar" class="w-full h-full rounded-full object-cover">`;
        } else {
          avatar.innerHTML = `<i class="fas fa-user"></i>`;
        }
        
        // Load user points and stats
        await loadUserPoints();
        await loadUserStats();
        
      } catch (error) {
        console.error('Error loading user data:', error);
      }
    }

    // Load user points
    async function loadUserPoints() {
      try {
        if (window.wonkDB && currentUser) {
          const userData = await window.wonkDB.getUser(currentUser.uid);
          if (userData) {
            userPoints = userData.points || 1000;
          } else {
            // Create new user with default points
            await window.wonkDB.createUser(currentUser.uid, {
              email: currentUser.email,
              displayName: currentUser.displayName,
              photoURL: currentUser.photoURL,
              walletAddress: currentUser.walletAddress || null,
              loginMethod: currentUser.loginMethod || "unknown"
            });
            userPoints = 1000;
          }
        } else {
          // Fallback to localStorage
          const savedPoints = localStorage.getItem(`user_points_${currentUser.uid}`);
          userPoints = savedPoints ? parseInt(savedPoints) : 1000;
        }
        
        // Update points display
        document.getElementById('userPointsDisplay').textContent = userPoints.toLocaleString();
        
      } catch (error) {
        console.error('Error loading user points:', error);
        userPoints = 1000;
        document.getElementById('userPointsDisplay').textContent = userPoints.toLocaleString();
      }
    }

    // Load user statistics
    async function loadUserStats() {
      try {
        let stats = {
          totalVotes: 0,
          pointsSpent: 0,
          joinDate: new Date().toLocaleDateString()
        };
        
        if (window.wonkDB && currentUser) {
          const userData = await window.wonkDB.getUser(currentUser.uid);
          if (userData) {
            stats = {
              totalVotes: userData.totalVotes || 0,
              pointsSpent: userData.totalSpent || 0,
              joinDate: userData.joinDate ? userData.joinDate.toDate().toLocaleDateString() : new Date().toLocaleDateString()
            };
          }
        }
        
        // Update stats display
        document.getElementById('userTotalVotes').textContent = stats.totalVotes.toLocaleString();
        document.getElementById('userPointsSpent').textContent = stats.pointsSpent.toLocaleString();
        document.getElementById('userJoinDate').textContent = stats.joinDate;
        
        // Update wallet info
        if (currentUser.walletAddress) {
          document.getElementById('userWallet').textContent = `${currentUser.walletAddress.substring(0, 8)}...`;
        }
        
      } catch (error) {
        console.error('Error loading user stats:', error);
      }
    }

    // Load voting cards
    async function loadVotingCards() {
      try {
        let cryptos;
        
        if (window.wonkDB) {
          cryptos = await window.wonkDB.getCryptos();
        }
        
        if (!cryptos || cryptos.length === 0) {
          // Default cryptos
          cryptos = [
            { name: "MOONSHOT", icon: "🚀", color: "blue", totalVotes: 2150 },
            { name: "DIAMOND", icon: "💎", color: "green", totalVotes: 1250 },
            { name: "LIGHTNING", icon: "⚡", color: "purple", totalVotes: 750 },
            { name: "ROCKET", icon: "🌙", color: "yellow", totalVotes: 890 },
            { name: "FIRE", icon: "🔥", color: "red", totalVotes: 1120 },
            { name: "STAR", icon: "⭐", color: "orange", totalVotes: 680 }
          ];
        }

        const votingCards = document.getElementById("votingCards");
        if (!votingCards) return;

        votingCards.innerHTML = cryptos.map(crypto => `
          <div class="voting-card glass-panel p-6 rounded-2xl" onclick="voteForCrypto('${crypto.name}', 10)">
            <div class="text-center mb-4">
              <div class="w-16 h-16 bg-gradient-to-br from-${crypto.color}-400 to-${crypto.color}-600 rounded-full flex items-center justify-center text-2xl font-bold mx-auto mb-3">
                ${crypto.icon}
              </div>
              <h4 class="text-xl font-bold text-${crypto.color}-400">${crypto.name}</h4>
              <p class="text-gray-400 text-sm">Community Choice</p>
            </div>
            
            <div class="mb-4">
              <div class="flex justify-between text-sm mb-2">
                <span>Total Votes: ${(crypto.totalVotes || 0).toLocaleString()}</span>
                <span class="text-${crypto.color}-400 font-bold">ACTIVE</span>
              </div>
              <div class="w-full bg-gray-700 rounded-full h-3">
                <div class="bg-gradient-to-r from-${crypto.color}-400 to-${crypto.color}-600 h-3 rounded-full transition-all duration-500" style="width: ${Math.min((crypto.totalVotes || 0) / 30, 100)}%"></div>
              </div>
            </div>

            <div class="bg-black bg-opacity-50 p-3 rounded-lg mb-4">
              <div class="text-xs text-gray-400 mb-1">VOTE COST:</div>
              <div class="flex items-center justify-between">
                <span class="text-${crypto.color}-400 font-bold">10 POINTS</span>
                <i class="fas fa-coins text-gold-400"></i>
              </div>
            </div>

            <div class="action-btn w-full bg-gradient-to-r from-${crypto.color}-400 to-${crypto.color}-600 text-center">
              <i class="fas fa-vote-yea mr-2"></i>
              VOTE NOW
            </div>
          </div>
        `).join("");
      } catch (error) {
        console.error("Error loading voting cards:", error);
      }
    }

    // Switch voting mode
    function switchVotingMode(mode) {
      votingMode = mode;
      
      // Update button states
      document.getElementById('traditionalVoteBtn').classList.toggle('action-btn', mode !== 'traditional');
      document.getElementById('traditionalVoteBtn').classList.toggle('bg-gold-500', mode === 'traditional');
      document.getElementById('blockchainVoteBtn').classList.toggle('action-btn', mode !== 'blockchain');
      document.getElementById('blockchainVoteBtn').classList.toggle('bg-gold-500', mode === 'blockchain');
      
      // Update info panel
      const infoTitle = document.getElementById('votingModeTitle');
      const infoDesc = document.getElementById('votingModeDescription');
      
      if (mode === 'blockchain') {
        infoTitle.textContent = 'Blockchain Voting Mode';
        infoDesc.textContent = 'Votes are recorded on the blockchain for maximum transparency and security.';
      } else {
        infoTitle.textContent = 'Traditional Voting Mode';
        infoDesc.textContent = 'Votes are stored in our secure database. Fast and reliable.';
      }
    }

    // Vote for crypto
    async function voteForCrypto(cryptoName, cost) {
      if (userPoints < cost) {
        showErrorMessage("Insufficient points! Please buy more points.");
        showBuyPointsModal();
        return;
      }

      try {
        if (votingMode === 'blockchain') {
          // Use blockchain voting
          if (window.blockchainVoting) {
            await window.blockchainVoting.vote(cryptoName, cost);
          } else {
            throw new Error('Blockchain voting not available');
          }
        } else {
          // Use traditional voting
          if (window.wonkDB && currentUser) {
            await window.wonkDB.recordVote(currentUser.uid, cryptoName, cost);
            await window.wonkDB.recordTransaction(currentUser.uid, "vote", cost, {
              cryptoName: cryptoName,
              action: "vote_cast"
            });
          }
        }
        
        // Update user points
        userPoints -= cost;
        await saveUserPoints();
        
        // Update UI
        document.getElementById('userPointsDisplay').textContent = userPoints.toLocaleString();
        
        // Add to live feed
        addVoteToFeed(currentUser.uid, cryptoName);
        
        showSuccessMessage(`Successfully voted for ${cryptoName}!`);
        
        // Reload voting cards after a delay
        setTimeout(() => {
          loadVotingCards();
        }, 1000);
        
      } catch (error) {
        console.error("Error voting:", error);
        showErrorMessage("Failed to cast vote. Please try again.");
      }
    }

    // Save user points
    async function saveUserPoints() {
      try {
        if (window.wonkDB && currentUser) {
          await window.wonkDB.updateUserPoints(currentUser.uid, userPoints);
        } else {
          localStorage.setItem(`user_points_${currentUser.uid}`, userPoints.toString());
        }
      } catch (error) {
        console.error("Error saving user points:", error);
        localStorage.setItem(`user_points_${currentUser.uid}`, userPoints.toString());
      }
    }

    // Start live votes feed
    function startLiveVotesFeed() {
      const liveVotesFeed = document.getElementById("liveVotesFeed");
      if (!liveVotesFeed) return;
      
      if (window.wonkDB) {
        const unsubscribe = window.wonkDB.listenToRecentVotes((votes) => {
          liveVotesFeed.innerHTML = votes.map(vote => `
            <div class="flex items-center justify-between p-3 mb-2 bg-black bg-opacity-30 rounded-lg animate-fade-in">
              <div class="flex items-center space-x-3">
                <div class="w-8 h-8 bg-gradient-to-br from-blue-400 to-purple-500 rounded-full flex items-center justify-center">
                  <i class="fas fa-user text-xs"></i>
                </div>
                <div>
                  <div class="text-sm font-bold text-blue-400">${vote.userId.substring(0, 8)}...</div>
                  <div class="text-xs text-gray-400">Voted for ${vote.cryptoName || 'crypto'}</div>
                </div>
              </div>
              <div class="text-xs text-gray-400">
                ${vote.timestamp ? formatTimeAgo(vote.timestamp.toDate ? vote.timestamp.toDate().getTime() : Date.now()) : "Just now"}
              </div>
            </div>
          `).join("");
        }, 20);
      } else {
        // Demo feed
        const demoVotes = [
          { userId: "user001", cryptoName: "BITCOIN", timestamp: Date.now() - 300000 },
          { userId: "user002", cryptoName: "ETHEREUM", timestamp: Date.now() - 250000 },
          { userId: "user003", cryptoName: "SOLANA", timestamp: Date.now() - 200000 }
        ];
        
        liveVotesFeed.innerHTML = demoVotes.map(vote => `
          <div class="flex items-center justify-between p-3 mb-2 bg-black bg-opacity-30 rounded-lg animate-fade-in">
            <div class="flex items-center space-x-3">
              <div class="w-8 h-8 bg-gradient-to-br from-blue-400 to-purple-500 rounded-full flex items-center justify-center">
                <i class="fas fa-user text-xs"></i>
              </div>
              <div>
                <div class="text-sm font-bold text-blue-400">${vote.userId}</div>
                <div class="text-xs text-gray-400">Voted for ${vote.cryptoName}</div>
              </div>
            </div>
            <div class="text-xs text-gray-400">
              ${formatTimeAgo(vote.timestamp)}
            </div>
          </div>
        `).join("");
      }
    }

    // Add vote to feed
    function addVoteToFeed(userId, cryptoName) {
      const liveVotesFeed = document.getElementById("liveVotesFeed");
      if (!liveVotesFeed) return;
      
      const voteElement = document.createElement("div");
      voteElement.className = "flex items-center justify-between p-3 mb-2 bg-black bg-opacity-30 rounded-lg animate-fade-in";
      voteElement.innerHTML = `
        <div class="flex items-center space-x-3">
          <div class="w-8 h-8 bg-gradient-to-br from-blue-400 to-purple-500 rounded-full flex items-center justify-center">
            <i class="fas fa-user text-xs"></i>
          </div>
          <div>
            <div class="text-sm font-bold text-blue-400">${userId.substring(0, 8)}...</div>
            <div class="text-xs text-gray-400">Voted for ${cryptoName}</div>
          </div>
        </div>
        <div class="text-xs text-gray-400">
          Just now
        </div>
      `;
      
      if (liveVotesFeed.firstChild) {
        liveVotesFeed.insertBefore(voteElement, liveVotesFeed.firstChild);
      } else {
        liveVotesFeed.appendChild(voteElement);
      }

      // Keep only the last 20 votes
      while (liveVotesFeed.children.length > 20) {
        liveVotesFeed.removeChild(liveVotesFeed.lastChild);
      }
    }

    // Modal functions
    function showBuyPointsModal() {
      document.getElementById('buyPointsModal').classList.remove('hidden');
    }

    function hideBuyPointsModal() {
      document.getElementById('buyPointsModal').classList.add('hidden');
      selectedPointsPackage = null;
      document.getElementById('purchasePointsBtn').disabled = true;
    }

    function selectPointsPackage(points, price) {
      selectedPointsPackage = { points, price };
      document.getElementById('purchasePointsBtn').disabled = false;
      
      // Update UI to show selection
      const packages = document.querySelectorAll('#buyPointsModal .glass-dark');
      packages.forEach(pkg => pkg.classList.remove('border-2', 'border-gold-400'));
      event.currentTarget.classList.add('border-2', 'border-gold-400');
    }

    async function purchasePoints() {
      if (!selectedPointsPackage) return;
      
      try {
        // In a real implementation, this would process the payment
        // For now, we'll simulate the purchase
        userPoints += selectedPointsPackage.points;
        await saveUserPoints();
        
        // Update UI
        document.getElementById('userPointsDisplay').textContent = userPoints.toLocaleString();
        
        // Record transaction
        if (window.wonkDB && currentUser) {
          await window.wonkDB.recordTransaction(currentUser.uid, "purchase", selectedPointsPackage.points, {
            price: selectedPointsPackage.price,
            currency: "SOL",
            action: "points_purchase"
          });
        }
        
        showSuccessMessage(`Successfully purchased ${selectedPointsPackage.points} points!`);
        hideBuyPointsModal();
        
      } catch (error) {
        console.error('Error purchasing points:', error);
        showErrorMessage('Failed to purchase points. Please try again.');
      }
    }

    function showChangePasswordModal() {
      document.getElementById('changePasswordModal').classList.remove('hidden');
    }

    function hideChangePasswordModal() {
      document.getElementById('changePasswordModal').classList.add('hidden');
      document.getElementById('changePasswordForm').reset();
    }

    function showTransactionHistory() {
      document.getElementById('transactionHistoryModal').classList.remove('hidden');
      loadTransactionHistory();
    }

    function hideTransactionHistory() {
      document.getElementById('transactionHistoryModal').classList.add('hidden');
    }

    async function loadTransactionHistory() {
      const content = document.getElementById('transactionHistoryContent');
      if (!content) return;
      
      try {
        let transactions = [];
        
        if (window.wonkDB && currentUser) {
          transactions = await window.wonkDB.getUserTransactions(currentUser.uid);
        } else {
          // Demo transactions
          transactions = [
            { type: 'vote', amount: 10, details: { cryptoName: 'BITCOIN' }, timestamp: new Date(Date.now() - 300000) },
            { type: 'purchase', amount: 100, details: { price: 0.01 }, timestamp: new Date(Date.now() - 600000) },
            { type: 'vote', amount: 10, details: { cryptoName: 'ETHEREUM' }, timestamp: new Date(Date.now() - 900000) }
          ];
        }
        
        content.innerHTML = transactions.map(tx => `
          <div class="flex items-center justify-between p-3 bg-black bg-opacity-30 rounded-lg">
            <div class="flex items-center space-x-3">
              <i class="fas fa-${tx.type === 'vote' ? 'vote-yea' : 'shopping-cart'} text-${tx.type === 'vote' ? 'blue' : 'green'}-400"></i>
              <div>
                <div class="font-bold">${tx.type === 'vote' ? 'Vote Cast' : 'Points Purchase'}</div>
                <div class="text-sm text-gray-400">
                  ${tx.type === 'vote' ? `Voted for ${tx.details.cryptoName}` : `Purchased ${tx.amount} points`}
                </div>
              </div>
            </div>
            <div class="text-right">
              <div class="font-bold ${tx.type === 'vote' ? 'text-red-400' : 'text-green-400'}">
                ${tx.type === 'vote' ? '-' : '+'}${tx.amount} points
              </div>
              <div class="text-xs text-gray-400">
                ${tx.timestamp ? tx.timestamp.toLocaleDateString() : 'Unknown'}
              </div>
            </div>
          </div>
        `).join('');
        
      } catch (error) {
        console.error('Error loading transaction history:', error);
        content.innerHTML = '<div class="text-center text-gray-400">Failed to load transaction history</div>';
      }
    }

    // Connect Phantom Wallet
    async function connectPhantomWallet() {
      try {
        if (!window.solana || !window.solana.isPhantom) {
          showErrorMessage("Phantom Wallet not detected. Please install the Phantom extension.");
          return;
        }

        const response = await window.solana.connect();
        const publicKey = response.publicKey.toString();
        
        // Update user data
        currentUser.walletAddress = publicKey;
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        
        // Update UI
        document.getElementById('userWallet').textContent = `${publicKey.substring(0, 8)}...`;
        
        // Update database
        if (window.wonkDB) {
          await window.wonkDB.updateUser(currentUser.uid, { walletAddress: publicKey });
        }
        
        showSuccessMessage("Phantom Wallet connected successfully!");
        
      } catch (error) {
        console.error("Error connecting Phantom wallet:", error);
        showErrorMessage("Failed to connect Phantom wallet.");
      }
    }

    // Export user data
    function exportUserData() {
      const userData = {
        user: currentUser,
        points: userPoints,
        exportDate: new Date().toISOString()
      };
      
      const dataStr = JSON.stringify(userData, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      
      const link = document.createElement('a');
      link.href = URL.createObjectURL(dataBlob);
      link.download = `wonk-user-data-${currentUser.uid.substring(0, 8)}.json`;
      link.click();
      
      showSuccessMessage("User data exported successfully!");
    }

    // Setup event listeners
    function setupEventListeners() {
      // Change password form
      const changePasswordForm = document.getElementById('changePasswordForm');
      if (changePasswordForm) {
        changePasswordForm.addEventListener('submit', handleChangePassword);
      }
      
      // Close modals on outside click
      document.addEventListener('click', function(e) {
        if (e.target.classList.contains('modal-overlay')) {
          e.target.classList.add('hidden');
        }
      });
    }

    // Handle change password
    async function handleChangePassword(event) {
      event.preventDefault();
      
      const currentPassword = document.getElementById('currentPassword').value;
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      
      if (newPassword !== confirmPassword) {
        showErrorMessage("New passwords don't match!");
        return;
      }
      
      try {
        // In a real implementation, this would update the password
        // For now, we'll simulate success
        showSuccessMessage("Password updated successfully!");
        hideChangePasswordModal();
        
      } catch (error) {
        console.error('Error changing password:', error);
        showErrorMessage('Failed to change password. Please try again.');
      }
    }

    // Logout function
    function logout() {
      localStorage.removeItem('currentUser');
      localStorage.removeItem(`user_points_${currentUser?.uid}`);
      
      if (firebase.auth().currentUser) {
        firebase.auth().signOut();
      }
      
      window.location.href = 'index.html';
    }

    // Utility functions
    function formatTimeAgo(timestamp) {
      const seconds = Math.floor((Date.now() - timestamp) / 1000);

      let interval = seconds / 31536000;
      if (interval > 1) {
        return Math.floor(interval) + " years ago";
      }
      interval = seconds / 2592000;
      if (interval > 1) {
        return Math.floor(interval) + " months ago";
      }
      interval = seconds / 86400;
      if (interval > 1) {
        return Math.floor(interval) + " days ago";
      }
      interval = seconds / 3600;
      if (interval > 1) {
        return Math.floor(interval) + " hours ago";
      }
      interval = seconds / 60;
      if (interval > 1) {
        return Math.floor(interval) + " minutes ago";
      }
      return Math.floor(seconds) + " seconds ago";
    }

    function showSuccessMessage(message) {
      console.log("SUCCESS:", message);
      // In a real app, you'd show a toast notification
    }

    function showErrorMessage(message) {
      console.error("ERROR:", message);
      // In a real app, you'd show a toast notification
    }
  </script>
</body>
</html>

